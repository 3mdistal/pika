{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://bwrb.dev/schema.schema.json",
  "title": "Bowerbird Schema",
  "description": "Schema for defining types, fields, and configuration for markdown vaults",
  "type": "object",
  "required": ["types"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this JSON Schema for editor support"
    },
    "version": {
      "type": "integer",
      "default": 2,
      "description": "Schema format version (2 = inheritance model)"
    },
    "schemaVersion": {
      "type": "string",
      "description": "User-controlled schema content version for migrations (semver)"
    },
    "config": {
      "$ref": "#/definitions/config"
    },
    "types": {
      "type": "object",
      "description": "Type definitions with inheritance support",
      "additionalProperties": {
        "$ref": "#/definitions/typeNode"
      }
    },
    "audit": {
      "$ref": "#/definitions/auditConfig"
    }
  },
  "definitions": {
    "config": {
      "type": "object",
      "description": "Vault-wide configuration options",
      "additionalProperties": false,
      "properties": {
        "link_format": {
          "type": "string",
          "enum": ["wikilink", "markdown"],
          "default": "wikilink",
          "description": "Link format for relation fields: wikilink (\"[[Note]]\") or markdown (\"[Note](Note.md)\")"
        },
        "editor": {
          "type": "string",
          "description": "Terminal editor command (defaults to $EDITOR)"
        },
        "visual": {
          "type": "string",
          "description": "GUI editor command (defaults to $VISUAL)"
        },
        "open_with": {
          "type": "string",
          "enum": ["system", "editor", "visual", "obsidian"],
          "default": "system",
          "description": "Default behavior for --open flag"
        },
        "obsidian_vault": {
          "type": "string",
          "description": "Obsidian vault name for URI scheme (auto-detected if not set)"
        },
        "default_dashboard": {
          "type": "string",
          "description": "Dashboard to run when `bwrb dashboard` is called without arguments"
        },
        "date_format": {
          "type": "string",
          "description": "Date format for date fields (defaults to YYYY-MM-DD)"
        }
      }
    },
    "auditConfig": {
      "type": "object",
      "description": "Configuration for the audit command",
      "additionalProperties": false,
      "properties": {
        "ignored_directories": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Directories to skip during audit"
        },
        "allowed_extra_fields": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Extra frontmatter fields that are allowed without warning"
        }
      }
    },
    "typeDefinition": {
      "type": "object",
      "required": ["output_dir", "frontmatter"],
      "additionalProperties": false,
      "properties": {
        "output_dir": {
          "type": "string",
          "description": "Directory path relative to vault root where files of this type are created"
        },
        "filename": {
          "type": "string",
          "description": "Filename pattern"
        },
        "frontmatter": {
          "type": "object",
          "description": "Frontmatter field definitions in order",
          "additionalProperties": {
            "$ref": "#/definitions/frontmatterField"
          }
        },
        "frontmatter_order": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Order of frontmatter fields (keys from frontmatter object)"
        },
        "body_sections": {
          "type": "array",
          "description": "Body sections to generate after frontmatter",
          "items": {
            "$ref": "#/definitions/bodySection"
          }
        }
      }
    },
    "typeNode": {
      "type": "object",
      "description": "Recursive type family or leaf definition",
      "additionalProperties": false,
      "properties": {
        "subtypes": {
          "type": "object",
          "description": "Nested subtype map",
          "additionalProperties": {
            "$ref": "#/definitions/typeNode"
          }
        },
        "output_dir": { "type": "string" },
        "filename": { "type": "string", "description": "Filename pattern" },
        "frontmatter": {
          "$ref": "#/definitions/typeDefinition/properties/frontmatter"
        },
        "frontmatter_order": { "type": "array", "items": { "type": "string" } },
        "body_sections": {
          "type": "array",
          "items": { "$ref": "#/definitions/bodySection" }
        },
        "plural": {
          "type": "string",
          "description": "Custom plural form for folder naming (e.g., 'research' instead of 'researches')"
        },
        "extends": {
          "type": "string",
          "description": "Parent type name (v2 inheritance model)"
        },
        "fields": {
          "type": "object",
          "description": "Field definitions (v2 model, replaces frontmatter)",
          "additionalProperties": {
            "$ref": "#/definitions/frontmatterField"
          }
        },
        "field_order": { "type": "array", "items": { "type": "string" }, "description": "Field ordering (v2 model)" },
        "recursive": { "type": "boolean", "description": "Whether this type can contain instances of itself" }
      },
      "anyOf": [
        { "required": ["subtypes"] },
        { "required": ["output_dir", "frontmatter"] },
        { "required": ["extends"] },
        { "required": ["fields"] }
      ]
    },
    "frontmatterField": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "value": {
          "type": "string",
          "description": "Static value (use $NOW for current datetime, $TODAY for date)"
        },
        "prompt": {
          "type": "string",
          "enum": ["text", "select", "relation", "list", "date", "boolean", "number"],
          "description": "Type of prompt: text (free text), select (from enum), relation (from vault query), list (comma-separated list), date (date picker), boolean (yes/no), number (numeric input)"
        },
        "label": {
          "type": "string",
          "description": "Label shown to user for input prompts"
        },
        "options": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Allowed values for select fields (inline options)"
        },
        "source": {
          "description": "Type name(s) for relation prompts",
          "anyOf": [
            { "type": "string" },
            { "type": "array", "items": { "type": "string" } }
          ]
        },
        "filter": {
          "type": "object",
          "description": "Filter conditions for type-based source queries",
          "additionalProperties": {
            "$ref": "#/definitions/filterCondition"
          }
        },
        "multiple": {
          "type": "boolean",
          "description": "Whether this field can hold multiple values"
        },
        "owned": {
          "type": "boolean",
          "description": "Whether children referenced by this field are owned (colocate with parent)"
        },
        "default": {
          "description": "Default value if user skips the prompt",
          "anyOf": [
            { "type": "string" },
            { "type": "array", "items": { "type": "string" } }
          ]
        },
        "required": {
          "type": "boolean",
          "description": "Whether this field is required (user cannot skip)"
        },
        "list_format": {
          "type": "string",
          "enum": ["yaml-array", "comma-separated"],
          "description": "For list fields, how to format the list"
        }
      }
    },
    "bodySection": {
      "type": "object",
      "required": ["title"],
      "additionalProperties": false,
      "properties": {
        "title": {
          "type": "string",
          "description": "Section heading text"
        },
        "level": {
          "type": "integer",
          "minimum": 2,
          "maximum": 6,
          "default": 2,
          "description": "Heading level (2 = ##, 3 = ###, etc.)"
        },
        "content_type": {
          "type": "string",
          "enum": ["none", "paragraphs", "bullets", "checkboxes"],
          "default": "none",
          "description": "Type of content placeholder to add"
        },
        "prompt": {
          "type": "string",
          "enum": ["none", "list"],
          "description": "If set, prompts user for initial content during creation"
        },
        "prompt_label": {
          "type": "string",
          "description": "Label for the content prompt"
        },
        "children": {
          "type": "array",
          "description": "Nested subsections",
          "items": {
            "$ref": "#/definitions/bodySection"
          }
        }
      }
    },
    "filterCondition": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "equals": {
          "type": "string",
          "description": "Field must equal this value"
        },
        "not_equals": {
          "type": "string",
          "description": "Field must not equal this value"
        },
        "in": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Field must be one of these values"
        },
        "not_in": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Field must not be one of these values"
        }
      }
    }
  }
}
